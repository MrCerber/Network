#!/bin/bash

# ----- Colors (REAL ESC) -----
T=$'\e[38;5;45m'     # title
L=$'\e[38;5;81m'     # label
X=$'\e[38;5;252m'    # text
DIM=$'\e[38;5;240m'
OK=$'\e[38;5;82m'
BAD=$'\e[38;5;196m'
NI=$'\e[38;5;244m'   # not installed
R=$'\e[0m'

LOGO_FILE="/etc/update-motd.d/logo.txt"
USER_NAME="${PAM_USER:-$USER}"

is_utf8() {
  local loc="${LC_ALL:-${LC_CTYPE:-${LANG:-}}}"
  case "$loc" in
    *UTF-8*|*utf8*) return 0 ;;
    *) return 1 ;;
  esac
}

COLS="$(tput cols 2>/dev/null || echo 80)"
if ! [[ "$COLS" =~ ^[0-9]+$ ]]; then
  COLS=80
fi
RULE_WIDTH="$COLS"
if (( RULE_WIDTH > 60 )); then
  RULE_WIDTH=60
elif (( RULE_WIDTH < 30 )); then
  RULE_WIDTH=30
fi
RULE_LINE="$(printf '%*s' "$RULE_WIDTH" '' | tr ' ' '-')"
LABEL_W=12

BAR_FULL="#"
BAR_EMPTY="-"
if is_utf8; then
  BAR_FULL=$'\u2588'
  BAR_EMPTY=$'\u2591'
fi

# ----- Helpers -----
h() {
  printf "\n%b%s%b\n" "$T" "$1" "$R"
  printf "%b%s%b\n" "$DIM" "$RULE_LINE" "$R"
}
kv() { printf "%b  %-*s%b %s%b\n" "$L" "$LABEL_W" "$1" "$R" "$2" "$R"; }

# Rainbow: 6 colors, Blue -> Cyan -> Green (salad)
rainbow_logo() {
  local colors=(33 39 45 51 82 118)
  local i=0
  while IFS= read -r line; do
    printf "\e[38;5;%sm%s%b\n" "${colors[i]}" "$line" "$R"
    i=$(( (i+1) % ${#colors[@]} ))
  done
}

# Services: active / stopped / not installed
svc() {
  local name="$1"
  local load_state
  load_state="$(systemctl show -p LoadState --value "$name" 2>/dev/null)"

  if [ -z "$load_state" ] || [ "$load_state" = "not-found" ]; then
    printf "%bnot installed%b" "$NI" "$R"
    return 0
  fi

  if systemctl is-active --quiet "$name" 2>/dev/null; then
    printf "%bactive%b" "$OK" "$R"
  else
    printf "%bstopped%b" "$BAD" "$R"
  fi
}

bar() {
  local pct="$1" len="${2:-22}"
  local filled=$(( pct * len / 100 ))
  local empty=$(( len - filled ))
  local out=""
  for ((i=0;i<filled;i++)); do out+="${BAR_FULL}"; done
  for ((i=0;i<empty;i++)); do out+="${BAR_EMPTY}"; done
  printf "%s" "$out"
}

# ----- Fast system data -----
HOST=$(hostname)
IP=$(hostname -I | awk '{print $1}')
OS=$(awk -F= '/^PRETTY_NAME=/{gsub(/"/,"",$2); print $2}' /etc/os-release 2>/dev/null)
KERNEL=$(uname -r)
UPTIME=$(uptime -p)

# CPU (fast + VPS-safe cores calculation)
CPU_MODEL=$(awk -F: '/model name/ {gsub(/^[ \t]+/,"",$2); print $2; exit}' /proc/cpuinfo 2>/dev/null)
CPU_THREADS=$(nproc 2>/dev/null || echo 1)

CPU_CORES=$(
  awk '
    /^physical id/ {p=$4}
    /^core id/     {c=$4; k=p"-"c; if(!seen[k]++){cnt++}}
    END { if(cnt>0) print cnt; else print "" }
  ' /proc/cpuinfo 2>/dev/null
)
[ -z "$CPU_CORES" ] && CPU_CORES="$CPU_THREADS"
[ "$CPU_CORES" -le 0 ] && CPU_CORES="$CPU_THREADS"

# Load
LOAD1=$(awk '{print $1}' /proc/loadavg)
LOAD5=$(awk '{print $2}' /proc/loadavg)
LOAD15=$(awk '{print $3}' /proc/loadavg)

# normalized load (load1 per thread) + %
LOAD_NORM=$(awk -v l="$LOAD1" -v c="$CPU_THREADS" 'BEGIN{printf "%.2f", (c>0? l/c : l)}')
LOAD_PCT=$(awk -v n="$LOAD_NORM" 'BEGIN{p=n*100; if(p<0)p=0; printf "%.0f", p}')

# Memory
MEM_USED=$(free -h | awk '/Mem:/ {print $3}')
MEM_TOTAL=$(free -h | awk '/Mem:/ {print $2}')

# Last login (fast)
LAST_LOGIN=$(
  lastlog -u "$USER_NAME" 2>/dev/null | awk '
    NR==2{
      user=$1; from=$3;
      $1=$2=$3="";
      gsub(/^ +/,"");
      if ($0 ~ /\*\*Never logged in\*\*/) {print user" never logged in"; exit}
      print user" from "from" at " $0; exit
    }'
)

# storage /
DISK_PCT=$(df / | awk 'NR==2 {gsub(/%/,"",$5); print $5}')
DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')
DISK_BAR=$(bar "${DISK_PCT:-0}" 22)

# updates (FAST only if apt-check exists)
UPDATES_TOTAL="n/a"
UPDATES_SEC="n/a"
if [ -x /usr/lib/update-notifier/apt-check ]; then
  IFS=';' read -r UPDATES_TOTAL UPDATES_SEC < <(/usr/lib/update-notifier/apt-check 2>/dev/null)
fi

# ----- Fail2ban stats -----
F2B_AVAILABLE=0
F2B_CLIENT=""
if command -v fail2ban-client >/dev/null 2>&1; then
  F2B_CLIENT="fail2ban-client"
  F2B_AVAILABLE=1
elif [ -x /usr/bin/fail2ban-client ]; then
  F2B_CLIENT="/usr/bin/fail2ban-client"
  F2B_AVAILABLE=1
fi

F2B_STATUS=""
F2B_JAILS_RAW=""
F2B_JAILS=""
F2B_JAIL_NAMES=()
F2B_BANS=()
F2B_UNBANS=()
F2B_ACTIVE=()
F2B_HAS_UNBANS=0
F2B_W_JAIL=4
F2B_W_BANS=4
F2B_W_UNBANS=6
F2B_W_ACTIVE=6
F2B_JAIL_MAX=18
F2B_JAILS_DISPLAY=""

if [ "$F2B_AVAILABLE" -eq 1 ] && systemctl is-active --quiet fail2ban 2>/dev/null; then
  F2B_STATUS="$($F2B_CLIENT status 2>/dev/null || true)"
  if [ -n "$F2B_STATUS" ]; then
    F2B_JAILS_RAW="$(printf "%s\n" "$F2B_STATUS" | sed -n 's/.*Jail list:[[:space:]]*//p' | tr -d '\r')"
    F2B_JAILS="$(printf "%s" "$F2B_JAILS_RAW" | tr -d '[:space:]')"
  fi

  f2b_counters_from_raw() {
    printf "%s\n" "$1" | awk -F': *' '
      /Currently banned/ {cb=$2}
      /Total banned/ {tb=$2}
      /Total unbanned/ {tu=$2}
      END {print tb ";" tu ";" cb}
    '
  }

  F2B_JAIL_LIST=()
  if [ -n "$F2B_JAILS" ]; then
    IFS=',' read -r -a F2B_JAIL_LIST <<< "$F2B_JAILS"
  fi

  if [ "${#F2B_JAIL_LIST[@]}" -gt 0 ]; then
    for jail in "${F2B_JAIL_LIST[@]}"; do
      [ -n "$jail" ] || continue
      F2B_JAIL_RAW="$($F2B_CLIENT status "$jail" 2>/dev/null || true)"
      if ! printf "%s" "$F2B_JAIL_RAW" | grep -q "Status for the jail"; then
        continue
      fi
      IFS=';' read -r tb tu cb < <(f2b_counters_from_raw "$F2B_JAIL_RAW")
      if [ -z "$tb" ] && [ -z "$cb" ]; then
        continue
      fi
      F2B_JAIL_NAMES+=( "$jail" )
      F2B_BANS+=( "${tb:-0}" )
      F2B_UNBANS+=( "$tu" )
      F2B_ACTIVE+=( "${cb:-0}" )
      if [ -n "$tu" ]; then
        F2B_HAS_UNBANS=1
        if [ "${#tu}" -gt "$F2B_W_UNBANS" ]; then
          F2B_W_UNBANS="${#tu}"
        fi
      fi
      if [ "${#jail}" -gt "$F2B_W_JAIL" ]; then
        F2B_W_JAIL="${#jail}"
      fi
      if [ "${#tb}" -gt "$F2B_W_BANS" ]; then
        F2B_W_BANS="${#tb}"
      fi
      if [ "${#cb}" -gt "$F2B_W_ACTIVE" ]; then
        F2B_W_ACTIVE="${#cb}"
      fi
    done
  fi
  if [ -z "$F2B_JAILS_RAW" ] && [ "${#F2B_JAIL_NAMES[@]}" -gt 0 ]; then
    F2B_JAILS_RAW="${F2B_JAIL_NAMES[0]}"
    for ((i=1;i<${#F2B_JAIL_NAMES[@]};i++)); do
      F2B_JAILS_RAW+=", ${F2B_JAIL_NAMES[$i]}"
    done
  fi
fi

# ----- Output -----
echo
if [ -f "$LOGO_FILE" ]; then
  rainbow_logo < "$LOGO_FILE"
  echo
fi

h "System"
kv "Host"       "$HOST"
kv "IP"         "$IP"
kv "OS"         "${OS:-unknown}"
kv "Kernel"     "$KERNEL"
kv "Uptime"     "$UPTIME"
kv "CPU"        "${CPU_MODEL:-unknown}  ${DIM}(${CPU_CORES} cores / ${CPU_THREADS} threads)${R}"
kv "Load"       "${LOAD1} / ${LOAD5} / ${LOAD15}  ${DIM}(1m/5m/15m)${R}"
kv "Load%"      "${LOAD_PCT}%  ${DIM}(normalized: ${LOAD_NORM} per thread)${R}"
kv "RAM"        "${MEM_USED} / ${MEM_TOTAL}"
kv "Last Login" "${LAST_LOGIN:-unknown}"

h "Storage"
kv "Disk /" "[${DISK_BAR}]  ${DISK_PCT}%  ${DIM}(${DISK_USED}/${DISK_TOTAL})${R}"

h "Services"
kv "docker"   "$(svc docker)"
kv "fail2ban" "$(svc fail2ban)"
kv "ufw"      "$(svc ufw)"

h "Fail2ban"
if [ "$F2B_AVAILABLE" -eq 0 ]; then
  kv "Status" "${NI}not installed${R}"
elif ! systemctl is-active --quiet fail2ban 2>/dev/null; then
  kv "Status" "${BAD}stopped${R}"
else
  F2B_JAILS_DISPLAY="${F2B_JAILS_RAW:-unknown}"
  kv "Jails" "$F2B_JAILS_DISPLAY"
  if [ "${#F2B_JAIL_NAMES[@]}" -gt 0 ]; then
    if [ "$F2B_W_JAIL" -lt 8 ]; then
      F2B_W_JAIL=8
    elif [ "$F2B_W_JAIL" -gt "$F2B_JAIL_MAX" ]; then
      F2B_W_JAIL="$F2B_JAIL_MAX"
    fi
    if [ "$F2B_W_BANS" -lt 4 ]; then
      F2B_W_BANS=4
    fi
    if [ "$F2B_W_ACTIVE" -lt 6 ]; then
      F2B_W_ACTIVE=6
    fi
    if [ "$F2B_HAS_UNBANS" -eq 1 ] && [ "$F2B_W_UNBANS" -lt 6 ]; then
      F2B_W_UNBANS=6
    fi
    if [ "$F2B_HAS_UNBANS" -eq 1 ]; then
      printf "%b  %-*s%b %b%*s%b %b%*s%b %b%*s%b\n" \
        "$DIM" "$F2B_W_JAIL" "Jail" "$R" \
        "$DIM" "$F2B_W_BANS" "Bans" "$R" \
        "$DIM" "$F2B_W_UNBANS" "Unbans" "$R" \
        "$DIM" "$F2B_W_ACTIVE" "Active" "$R"
    else
      printf "%b  %-*s%b %b%*s%b %b%*s%b\n" \
        "$DIM" "$F2B_W_JAIL" "Jail" "$R" \
        "$DIM" "$F2B_W_BANS" "Bans" "$R" \
        "$DIM" "$F2B_W_ACTIVE" "Active" "$R"
    fi
    for i in "${!F2B_JAIL_NAMES[@]}"; do
      jail="${F2B_JAIL_NAMES[$i]}"
      if [ "${#jail}" -gt "$F2B_W_JAIL" ]; then
        jail="${jail:0:$((F2B_W_JAIL-1))}."
      fi
      tb="${F2B_BANS[$i]}"
      tu="${F2B_UNBANS[$i]}"
      cb="${F2B_ACTIVE[$i]}"
      if [ "$F2B_HAS_UNBANS" -eq 1 ]; then
        [ -n "$tu" ] || tu="-"
        printf "%b  %-*s%b %b%*s%b %b%*s%b %b%*s%b\n" \
          "$L" "$F2B_W_JAIL" "$jail" "$R" \
          "$X" "$F2B_W_BANS" "$tb" "$R" \
          "$X" "$F2B_W_UNBANS" "$tu" "$R" \
          "$X" "$F2B_W_ACTIVE" "$cb" "$R"
      else
        printf "%b  %-*s%b %b%*s%b %b%*s%b\n" \
          "$L" "$F2B_W_JAIL" "$jail" "$R" \
          "$X" "$F2B_W_BANS" "$tb" "$R" \
          "$X" "$F2B_W_ACTIVE" "$cb" "$R"
      fi
    done
  else
    kv "Info" "${DIM}No jail stats found${R}"
  fi
fi
echo

h "Updates"
if [ "$UPDATES_TOTAL" = "n/a" ]; then
  kv "Status" "${DIM}n/a (install update-notifier-common for fast counts)${R}"
else
  if [ "${UPDATES_TOTAL:-0}" -eq 0 ]; then
    kv "Status" "${OK}System is up to date${R}"
  else
    kv "Total"    "$UPDATES_TOTAL"
    kv "Security" "$UPDATES_SEC"
    kv "Hint"     "${DIM}Run: apt update && apt upgrade -y${R}"
  fi
fi
echo
