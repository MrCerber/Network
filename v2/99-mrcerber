#!/bin/bash

# ----- Colors (REAL ESC) -----
T=$'\e[38;5;45m'     # title
L=$'\e[38;5;81m'     # label
X=$'\e[38;5;252m'    # text
DIM=$'\e[38;5;240m'
OK=$'\e[38;5;82m'
BAD=$'\e[38;5;196m'
NI=$'\e[38;5;244m'   # not installed
R=$'\e[0m'

LOGO_FILE="/etc/update-motd.d/logo.txt"
USER_NAME="${PAM_USER:-$USER}"

is_utf8() {
  if [[ "${MOTD_ASCII:-0}" == "1" ]]; then
    return 1
  fi
  return 0
}

COLS="$(tput cols 2>/dev/null || echo 80)"
if ! [[ "$COLS" =~ ^[0-9]+$ ]]; then
  COLS=80
fi
RULE_WIDTH="$COLS"
if (( RULE_WIDTH > 60 )); then
  RULE_WIDTH=60
elif (( RULE_WIDTH < 30 )); then
  RULE_WIDTH=30
fi
RULE_LINE="$(printf '%*s' "$RULE_WIDTH" '' | tr ' ' '-')"
LABEL_W=12

BAR_FULL="="
BAR_EMPTY="="
SVC_OK="o"
SVC_BAD="o"
SVC_NI="o"
if is_utf8; then
  BAR_FULL=$'\u2588'
  BAR_EMPTY=$'\u2591'
  SVC_OK=$'\u25CF'
  SVC_BAD=$'\u25CF'
  SVC_NI=$'\u25CB'
fi

# ----- Helpers -----
h() {
  printf "\n%b%s%b\n" "$T" "$1" "$R"
  printf "%b%s%b\n" "$DIM" "$RULE_LINE" "$R"
}
kv() { printf "%b  %-*s%b %s%b\n" "$L" "$LABEL_W" "$1" "$R" "$2" "$R"; }

# Rainbow: 6 colors, Blue -> Cyan -> Green (salad)
rainbow_logo() {
  local colors=(33 39 45 51 82 118)
  local i=0
  while IFS= read -r line; do
    printf "\e[38;5;%sm%s%b\n" "${colors[i]}" "$line" "$R"
    i=$(( (i+1) % ${#colors[@]} ))
  done
}

# Services: active / stopped / not installed
svc() {
  local name="$1"
  local load_state
  load_state="$(systemctl show -p LoadState --value "$name" 2>/dev/null)"

  if [ -z "$load_state" ] || [ "$load_state" = "not-found" ]; then
    printf "%b%s %s%b" "$NI" "$SVC_NI" "inactive" "$R"
    return 0
  fi

  if systemctl is-active --quiet "$name" 2>/dev/null; then
    printf "%b%s %s%b" "$OK" "$SVC_OK" "active" "$R"
  else
    printf "%b%s %s%b" "$BAD" "$SVC_BAD" "inactive" "$R"
  fi
}

svc_item() {
  local name="$1"
  local label="${2:-$1}"
  printf "%b%-10s%b %s" "$L" "${label}:" "$R" "$(svc "$name")"
}

bar() {
  local pct="$1" len="${2:-24}"
  local filled=$(( pct * len / 100 ))
  local empty=$(( len - filled ))
  local out=""
  out+="${DIM}[${R}"
  out+="${OK}"
  for ((i=0;i<filled;i++)); do out+="${BAR_FULL}"; done
  out+="${DIM}"
  for ((i=0;i<empty;i++)); do out+="${BAR_EMPTY}"; done
  out+="${DIM}]${R}"
  printf "%b" "$out"
}

# ----- Fast system data -----
HOST=$(hostname)
IP=$(hostname -I | awk '{print $1}')
OS=$(awk -F= '/^PRETTY_NAME=/{gsub(/"/,"",$2); print $2}' /etc/os-release 2>/dev/null)
KERNEL=$(uname -r)
UPTIME=$(uptime -p)

# CPU (fast + VPS-safe cores calculation)
CPU_MODEL=$(awk -F: '/model name/ {gsub(/^[ \t]+/,"",$2); print $2; exit}' /proc/cpuinfo 2>/dev/null)
CPU_THREADS=$(nproc 2>/dev/null || echo 1)

CPU_CORES=$(
  awk '
    /^physical id/ {p=$4}
    /^core id/     {c=$4; k=p"-"c; if(!seen[k]++){cnt++}}
    END { if(cnt>0) print cnt; else print "" }
  ' /proc/cpuinfo 2>/dev/null
)
[ -z "$CPU_CORES" ] && CPU_CORES="$CPU_THREADS"
[ "$CPU_CORES" -le 0 ] && CPU_CORES="$CPU_THREADS"

# Load
LOAD1=$(awk '{print $1}' /proc/loadavg)
LOAD5=$(awk '{print $2}' /proc/loadavg)
LOAD15=$(awk '{print $3}' /proc/loadavg)

# normalized load (load1 per thread) + %
LOAD_NORM=$(awk -v l="$LOAD1" -v c="$CPU_THREADS" 'BEGIN{printf "%.2f", (c>0? l/c : l)}')
LOAD_PCT=$(awk -v n="$LOAD_NORM" 'BEGIN{p=n*100; if(p<0)p=0; printf "%.0f", p}')

# Memory
MEM_USED=$(free -h | awk '/Mem:/ {print $3}')
MEM_TOTAL=$(free -h | awk '/Mem:/ {print $2}')

# Last login (fast)
LAST_LOGIN=$(
  lastlog -u "$USER_NAME" 2>/dev/null | awk '
    NR==2{
      user=$1; from=$3;
      $1=$2=$3="";
      gsub(/^ +/,"");
      if ($0 ~ /\*\*Never logged in\*\*/) {print user" never logged in"; exit}
      print user" from "from" at " $0; exit
    }'
)

# storage /
DISK_PCT=$(df / | awk 'NR==2 {gsub(/%/,"",$5); print $5}')
DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')
DISK_BAR=$(bar "${DISK_PCT:-0}" 24)

# updates (FAST only if apt-check exists)
UPDATES_TOTAL="n/a"
UPDATES_SEC="n/a"
if [ -x /usr/lib/update-notifier/apt-check ]; then
  IFS=';' read -r UPDATES_TOTAL UPDATES_SEC < <(/usr/lib/update-notifier/apt-check 2>/dev/null)
fi


# ----- Output -----
echo
if [ -f "$LOGO_FILE" ]; then
  rainbow_logo < "$LOGO_FILE"
  echo
fi

h "System"
kv "Host"       "$HOST"
kv "IP"         "$IP"
kv "OS"         "${OS:-unknown}"
kv "Kernel"     "$KERNEL"
kv "Uptime"     "$UPTIME"
kv "CPU"        "${CPU_MODEL:-unknown}  ${DIM}(${CPU_CORES} cores / ${CPU_THREADS} threads)${R}"
kv "Load"       "${LOAD1} / ${LOAD5} / ${LOAD15}  ${DIM}(1m/5m/15m)${R}"
kv "Load%"      "${LOAD_PCT}%  ${DIM}(normalized: ${LOAD_NORM} per thread)${R}"
kv "RAM"        "${MEM_USED} / ${MEM_TOTAL}"
kv "Last Login" "${LAST_LOGIN:-unknown}"

h "Storage"
kv "Disk /" "${DISK_BAR}  ${DISK_PCT}%  ${DIM}(${DISK_USED}/${DISK_TOTAL})${R}"

h "Services"
printf "  %s  %s\n" "$(svc_item docker)" "$(svc_item fail2ban)"
printf "  %s\n" "$(svc_item ufw)"

h "Updates"
if [ "$UPDATES_TOTAL" = "n/a" ]; then
  kv "Status" "${DIM}n/a (install update-notifier-common for fast counts)${R}"
else
  if [ "${UPDATES_TOTAL:-0}" -eq 0 ]; then
    kv "Status" "${OK}System is up to date${R}"
  else
    kv "Total"    "$UPDATES_TOTAL"
    kv "Security" "$UPDATES_SEC"
    kv "Hint"     "${DIM}Run: apt update && apt upgrade -y${R}"
  fi
fi
echo
